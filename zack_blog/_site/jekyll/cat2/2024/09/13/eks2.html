<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>EKS Security Practise with Kube-Bench and OPA Gatekeeper | Zack’s Blog</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="EKS Security Practise with Kube-Bench and OPA Gatekeeper" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="About kube-bench and OPA Gatekeeper" />
<meta property="og:description" content="About kube-bench and OPA Gatekeeper" />
<link rel="canonical" href="http://localhost:4000/jekyll/cat2/2024/09/13/eks2.html" />
<meta property="og:url" content="http://localhost:4000/jekyll/cat2/2024/09/13/eks2.html" />
<meta property="og:site_name" content="Zack’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-09-13T10:15:29+10:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="EKS Security Practise with Kube-Bench and OPA Gatekeeper" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-09-13T10:15:29+10:00","datePublished":"2024-09-13T10:15:29+10:00","description":"About kube-bench and OPA Gatekeeper","headline":"EKS Security Practise with Kube-Bench and OPA Gatekeeper","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/jekyll/cat2/2024/09/13/eks2.html"},"url":"http://localhost:4000/jekyll/cat2/2024/09/13/eks2.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Zack&apos;s Blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Zack&#39;s Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/certificate/">Education &amp; Certificate</a><a class="page-link" href="/pro/">Work Experiences</a><a class="page-link" href="/skillroadmap/">Skill Roadmap</a><a class="page-link" href="/aboutme/">About Me</a><a class="page-link" href="/gitrepo/">Github Repos</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">EKS Security Practise with Kube-Bench and OPA Gatekeeper </h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-09-13T10:15:29+10:00" itemprop="datePublished">Sep 13, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><b>About kube-bench and OPA Gatekeeper </b></p>

<p>In the last post, I was able to implement <a href="https://zackz.site/jekyll/cat2/2024/09/12/eks1.html">EKS cluster autoscaler and Horizontal Pod Autoscaler (HPA)</a>, in this post I will continue with EKS security practice with Kube-Bench and OPA Gatekeeper.</p>

<ul>
  <li>kube-bench:</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">kube-bench</code> is a tool that checks Kubernetes clusters against the CIS (Center for Internet Security) benchmarks, a set of best practices for securing Kubernetes. It is critical to ensure that a cluster complies with these security guidelines, helping identify potential vulnerabilities and misconfigurations. Key features include generating detailed audit reports, performing automated compliance checks, and easily integrating into existing CI/CD pipelines for continuous security assessments</p>

<ul>
  <li>OPA Gatekeeper</li>
</ul>

<p>OPA (Open Policy Agent) is a policy engine that allows to define and enforce policies across various services, including Kubernetes. <code class="language-plaintext highlighter-rouge">OPA Gatekeeper</code> extends OPA’s functionality specifically for Kubernetes by providing admission control, enabling the enforcement of custom policies on resources before they are created or modified. The benefits of using OPA Gatekeeper include consistent policy enforcement across the cluster, fine-grained control over resource configurations, and reducing the risk of misconfigurations by ensuring compliance with defined rules.</p>

<p><b>kube-bench in EKS</b></p>

<p>We will be based on <a href="https://github.com/aquasecurity/kube-bench/blob/main/docs/platforms.md#cis-kubernetes-benchmark-support">official cis-kubernetes-benchmark-support webpage</a>, to apply the kube-bench job yaml for EKS, when the job completed, the results are held in the pod’s logs.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span>kubectl.exe get node
NAME                                               STATUS   ROLES    AGE     VERSION
ip-172-31-37-215.ap-southeast-2.compute.internal   Ready    &lt;none&gt;   2m29s   v1.31.0-eks-a737599

<span class="c"># apply the job yaml for EKS</span>
kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/aquasecurity/kube-bench/refs/heads/main/job-eks.yaml

<span class="c"># check  the job status</span>
<span class="nv">$ </span>kubectl get pods
NAME                      READY   STATUS              RESTARTS   AGE
kube-bench-j76s9   0/1     ContainerCreating   0          3s

<span class="c"># Wait for a few seconds for the job to complete</span>
<span class="nv">$ </span>kubectl get pods
NAME                      READY   STATUS      RESTARTS   AGE
kube-bench-j76s9   0/1 Completed   0          11s

<span class="c"># The results are held in the pod's logs</span>
kubectl logs kube-bench-j76s9

<span class="o">[</span>INFO] 3 Worker Node Security Configuration
<span class="o">[</span>INFO] 3.1 Worker Node Configuration Files
<span class="o">[</span>PASS] 3.1.1 Ensure that the kubeconfig file permissions are <span class="nb">set </span>to 644 or more restrictive <span class="o">(</span>Manual<span class="o">)</span>
<span class="o">[</span>PASS] 3.1.2 Ensure that the kubelet kubeconfig file ownership is <span class="nb">set </span>to root:root <span class="o">(</span>Manual<span class="o">)</span>
<span class="o">[</span>PASS] 3.1.3 Ensure that the kubelet configuration file has permissions <span class="nb">set </span>to 644 or more restrictive <span class="o">(</span>Manual<span class="o">)</span>
<span class="o">[</span>PASS] 3.1.4 Ensure that the kubelet configuration file ownership is <span class="nb">set </span>to root:root <span class="o">(</span>Manual<span class="o">)</span>
<span class="o">[</span>INFO] 3.2 Kubelet
<span class="o">[</span>PASS] 3.2.1 Ensure that the Anonymous Auth is Not Enabled <span class="o">(</span>Automated<span class="o">)</span>
<span class="o">[</span>PASS] 3.2.2 Ensure that the <span class="nt">--authorization-mode</span> argument is not <span class="nb">set </span>to AlwaysAllow <span class="o">(</span>Automated<span class="o">)</span>
<span class="o">[</span>PASS] 3.2.3 Ensure that a Client CA File is Configured <span class="o">(</span>Manual<span class="o">)</span>
<span class="o">[</span>PASS] 3.2.4 Ensure that the <span class="nt">--read-only-port</span> is disabled <span class="o">(</span>Manual<span class="o">)</span>
<span class="o">[</span>PASS] 3.2.5 Ensure that the <span class="nt">--streaming-connection-idle-timeout</span> argument is not <span class="nb">set </span>to 0 <span class="o">(</span>Automated<span class="o">)</span>
<span class="o">[</span>PASS] 3.2.6 Ensure that the <span class="nt">--protect-kernel-defaults</span> argument is <span class="nb">set </span>to <span class="nb">true</span> <span class="o">(</span>Automated<span class="o">)</span>
<span class="o">[</span>PASS] 3.2.7 Ensure that the <span class="nt">--make-iptables-util-chains</span> argument is <span class="nb">set </span>to <span class="nb">true</span> <span class="o">(</span>Automated<span class="o">)</span> 
<span class="o">[</span>WARN] 3.2.8 Ensure that the <span class="nt">--hostname-override</span> argument is not <span class="nb">set</span> <span class="o">(</span>Manual<span class="o">)</span>
<span class="o">[</span>WARN] 3.2.9 Ensure that the <span class="nt">--eventRecordQPS</span> argument is <span class="nb">set </span>to 0 or a level which ensures appropriate event capture <span class="o">(</span>Automated<span class="o">)</span>
<span class="o">[</span>PASS] 3.2.10 Ensure that the <span class="nt">--rotate-certificates</span> argument is not present or is <span class="nb">set </span>to <span class="nb">true</span> <span class="o">(</span>Manual<span class="o">)</span>
<span class="o">[</span>PASS] 3.2.11 Ensure that the RotateKubeletServerCertificate argument is <span class="nb">set </span>to <span class="nb">true</span> <span class="o">(</span>Manual<span class="o">)</span>
<span class="o">[</span>INFO] 3.3 Container Optimized OS
<span class="o">[</span>WARN] 3.3.1 Prefer using a container-optimized OS when possible <span class="o">(</span>Manual<span class="o">)</span>

<span class="o">==</span> Remediations node <span class="o">==</span>
3.2.8 Edit the kubelet service file /etc/systemd/system/kubelet.service
on each worker node and remove the <span class="nt">--hostname-override</span> argument from the
KUBELET_SYSTEM_PODS_ARGS variable.
Based on your system, restart the kubelet service. For example:
systemctl daemon-reload
systemctl restart kubelet.service

3.2.9 If using a Kubelet config file, edit the file to <span class="nb">set </span>eventRecordQPS: to an appropriate level.
If using <span class="nb">command </span>line arguments, edit the kubelet service file
/etc/systemd/system/kubelet.service on each worker node and
<span class="nb">set </span>the below parameter <span class="k">in </span>KUBELET_SYSTEM_PODS_ARGS variable.
Based on your system, restart the kubelet service. For example:
systemctl daemon-reload
systemctl restart kubelet.service

3.3.1 audit <span class="nb">test </span>did not run: No tests defined

<span class="o">==</span> Summary node <span class="o">==</span>
13 checks PASS
0 checks FAIL
3 checks WARN
0 checks INFO

<span class="o">==</span> Summary total <span class="o">==</span>
13 checks PASS
0 checks FAIL
3 checks WARN
0 checks INFO</code></pre></figure>

<p>Based on the scan result, the EKS managed workder node can be secure will 13 check pass and 0 check fail, by following the remediation suggestion we can set the EKS cluster compliant with the CIS benchmark.</p>

<p><b>OPA Gatekeeper in EKS</b></p>

<ul>
  <li>Install the OPA Gatekeeper</li>
</ul>

<p>We will first install Gatekeeper in EKS cluster by applying the Gatekeeper installation manifests from <a href="https://open-policy-agent.github.io/gatekeeper/website/docs/install/">the official repository</a>.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/open-policy-agent/gatekeeper/v3.12.0/deploy/gatekeeper.yaml
namespace/gatekeeper-system created
resourcequota/gatekeeper-critical-pods created
customresourcedefinition.apiextensions.k8s.io/assign.mutations.gatekeeper.sh created
customresourcedefinition.apiextensions.k8s.io/assignimage.mutations.gatekeeper.sh created
customresourcedefinition.apiextensions.k8s.io/assignmetadata.mutations.gatekeeper.sh created
customresourcedefinition.apiextensions.k8s.io/configs.config.gatekeeper.sh created
customresourcedefinition.apiextensions.k8s.io/constraintpodstatuses.status.gatekeeper.sh created
customresourcedefinition.apiextensions.k8s.io/constrainttemplatepodstatuses.status.gatekeeper.sh created
customresourcedefinition.apiextensions.k8s.io/constrainttemplates.templates.gatekeeper.sh created
customresourcedefinition.apiextensions.k8s.io/expansiontemplate.expansion.gatekeeper.sh created
customresourcedefinition.apiextensions.k8s.io/modifyset.mutations.gatekeeper.sh created
customresourcedefinition.apiextensions.k8s.io/mutatorpodstatuses.status.gatekeeper.sh created
customresourcedefinition.apiextensions.k8s.io/providers.externaldata.gatekeeper.sh created
serviceaccount/gatekeeper-admin created
role.rbac.authorization.k8s.io/gatekeeper-manager-role created
clusterrole.rbac.authorization.k8s.io/gatekeeper-manager-role created
rolebinding.rbac.authorization.k8s.io/gatekeeper-manager-rolebinding created
clusterrolebinding.rbac.authorization.k8s.io/gatekeeper-manager-rolebinding created
secret/gatekeeper-webhook-server-cert created
service/gatekeeper-webhook-service created
deployment.apps/gatekeeper-audit created
deployment.apps/gatekeeper-controller-manager created
poddisruptionbudget.policy/gatekeeper-controller-manager created
mutatingwebhookconfiguration.admissionregistration.k8s.io/gatekeeper-mutating-webhook-configuration created
validatingwebhookconfiguration.admissionregistration.k8s.io/gatekeeper-validating-webhook-configuration created

<span class="nv">$ </span>kubectl.exe get all <span class="nt">-n</span> gatekeeper-system
NAME                                                 READY   STATUS    RESTARTS        AGE
pod/gatekeeper-audit-777f449c79-h7lzn                1/1 Running   1 <span class="o">(</span>3m35s ago<span class="o">)</span>   3m42s
pod/gatekeeper-controller-manager-84bf857ff7-rzlb8   1/1 Running   0               3m42s

NAME                                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
service/gatekeeper-webhook-service   ClusterIP   10.100.126.57 &lt;none&gt;        443/TCP   3m42s

NAME                                            READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/gatekeeper-audit                1/1     1            1           3m42s
deployment.apps/gatekeeper-controller-manager   1/1     1            1           3m42s

NAME                                                       DESIRED   CURRENT   READY   AGE
replicaset.apps/gatekeeper-audit-777f449c79                1         1         1       3m42s
replicaset.apps/gatekeeper-controller-manager-84bf857ff7   1         1         1       3m42s</code></pre></figure>

<ul>
  <li>OPA Gatekeeper works with two main components:</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">ConstraintTemplate</code>: Defines a reusable logic for policies.</p>

<p><code class="language-plaintext highlighter-rouge">Constraint</code>: Applies specific policies based on the logic defined in the ConstraintTemplate.</p>

<p>Here we will create a <code class="language-plaintext highlighter-rouge">ConstraintTemplate</code> and <code class="language-plaintext highlighter-rouge">required-label-policy</code> to enforce required labels during pod creation, and run a test pod with and without required labels to test the policy enforcement.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># Create a ConstraintTemplate and policy to enforce require-labels for pod creation</span>
vim required-label-template.yaml 

apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
 name: k8srequiredlabels
spec:
 crd:
 spec:
 names:
 kind: K8sRequiredLabels
 targets:
 - target: admission.k8s.gatekeeper.sh
 rego: |
 package k8srequiredlabels

 violation[<span class="o">{</span><span class="s2">"msg"</span>: msg<span class="o">}]</span> <span class="o">{</span>
 required_label :<span class="o">=</span> <span class="s2">"required-label"</span>
 not input.review.object.metadata.labels[required_label]
 msg :<span class="o">=</span> sprintf<span class="o">(</span><span class="s2">"You must provide the '%s' label on every resource."</span>, <span class="o">[</span>required_label]<span class="o">)</span>
 <span class="o">}</span>
<span class="nt">---</span>
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sRequiredLabels
metadata:
 name: require-labels
spec:
 match:
 kinds:
 - apiGroups: <span class="o">[</span><span class="s2">""</span><span class="o">]</span>
 kinds: <span class="o">[</span><span class="s2">"Pod"</span><span class="o">]</span>

<span class="c">#  Apply the ConstraintTemplate and policy</span>
<span class="nv">$ </span>kubectl.exe apply <span class="nt">-f</span> required-label-template.yaml 
constrainttemplate.templates.gatekeeper.sh/k8srequiredlabels configured
k8srequiredlabels.constraints.gatekeeper.sh/require-labels created

<span class="c"># Validate constraint templates</span>
<span class="nv">$ </span>kubectl get constrainttemplates
NAME                AGE
k8srequiredlabels   15s</code></pre></figure>

<p>Then we need to create a test pod with and without required labels to test the policy enforcement</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span>vim test-pod.yaml

apiVersion: v1
kind: Pod
metadata:
 name: test-pod
spec:
 containers:
 - name: test-container
 image: nginx

<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> test-pod.yaml
Error from server <span class="o">(</span>Forbidden<span class="o">)</span>: error when creating <span class="s2">"test-pod.yaml"</span>: admission webhook <span class="s2">"validation.gatekeeper.sh"</span> denied the request: <span class="o">[</span>require-labels] You must provide the <span class="s1">'required-label'</span> label on every resource.

<span class="nv">$ </span>vim test-pod-labeled.yaml

apiVersion: v1
kind: Pod
metadata:
 name: test-pod-labeled
 labels:
 required-label: <span class="s2">"true"</span>
spec:
 containers:
 - name: test-container
 image: nginx

<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> test-pod-labeled.yaml
pod/test-pod-labeled created

zack@zackz MINGW64 /f/1/terraform-eks <span class="o">(</span>master<span class="o">)</span>
<span class="nv">$ </span>kubectl.exe get po
NAME               READY   STATUS              RESTARTS   AGE
kube-bench-xrx8g   0/1     Completed           0          21m
test-pod-labeled   0/1     ContainerCreating   0          5s

<span class="nv">$ </span>kubectl.exe get po
NAME               READY   STATUS      RESTARTS   AGE
kube-bench-xrx8g   0/1 Completed   0          22m
test-pod-labeled   1/1 Running     0          24s</code></pre></figure>

<p>Based on the constraint we created before, the policy prevents the pod from being created with</p>

<p><code class="language-plaintext highlighter-rouge">Error from server (Forbidden): error when creating "test-pod.yaml": admission webhook "validation.gatekeeper.sh" denied the request: [require-labels] You must provide the 'required-label' label on every resource</code></p>

<p>this can be expanded to more strict rules to enforce k8s cluster to achieve the desired control.</p>

<p><b>Conclusion</b></p>

<p>In this post, we dive into the process of enhancing the security of an AWS EKS cluster by implementing and validating two critical security tools: Kube-bench and OPA Gatekeeper to get some hands-on to achieve a secure EKS environment by ensuring compliance with best practices and enforcing security policies at runtime.</p>

  </div><a class="u-url" href="/jekyll/cat2/2024/09/13/eks2.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Zack&#39;s Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Zack&#39;s Blog</li><li><a class="u-email" href="mailto:zhbsoftboy1@gmail.com">zhbsoftboy1@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/ZackZhouHB"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">ZackZhouHB</span></a></li><li><a href="https://www.twitter.com/ZackZ"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">ZackZ</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>## AWS   ## Jenkins  ## Microservices ## Automation ## K8S   ## CICD     ## Gitops </p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
