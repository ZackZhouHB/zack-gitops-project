<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Automate massive AWS EC2 tagging | Zack’s Blog</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Automate massive AWS EC2 tagging" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Backgroud" />
<meta property="og:description" content="Backgroud" />
<link rel="canonical" href="http://localhost:4000/jekyll/cat2/2024/05/01/AWS-tagging.html" />
<meta property="og:url" content="http://localhost:4000/jekyll/cat2/2024/05/01/AWS-tagging.html" />
<meta property="og:site_name" content="Zack’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-05-01T10:15:29+10:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Automate massive AWS EC2 tagging" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-05-01T10:15:29+10:00","datePublished":"2024-05-01T10:15:29+10:00","description":"Backgroud","headline":"Automate massive AWS EC2 tagging","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/jekyll/cat2/2024/05/01/AWS-tagging.html"},"url":"http://localhost:4000/jekyll/cat2/2024/05/01/AWS-tagging.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Zack&apos;s Blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Zack&#39;s Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/certificate/">Education &amp; Certificate</a><a class="page-link" href="/pro/">Work Experiences</a><a class="page-link" href="/skillroadmap/">Skill Roadmap</a><a class="page-link" href="/aboutme/">About Me</a><a class="page-link" href="/gitrepo/">Github Repos</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Automate massive AWS EC2 tagging</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-05-01T10:15:29+10:00" itemprop="datePublished">May 1, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><b> Backgroud </b></p>

<p>I was tasked to enforce mandatory tagging for ec2 instances, as there are a lot of machines and a lot of tags need to be attached to each machine, here I need a scripted way to get the job done.</p>

<p><b> How to achieve </b></p>

<ul>
  <li>Prepare a list of ec2 instances with default name tag only,</li>
</ul>

<p><img src="/assets/awstag2.png" alt="image tooltip here" /></p>

<ul>
  <li>Open cloud shell or ssh to a linux box where AWSCli installed and configured to a AWS account, export the instances with ID to a csv file</li>
</ul>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">root@ubt-server:~# aws ec2 describe-instances <span class="nt">--output</span> text <span class="nt">--query</span> <span class="s1">'Reservations[*].Instances[*].[InstanceId]'</span> <span class="o">&gt;</span> zztag.csv</code></pre></figure>

<ul>
  <li>Then add the header row for “instance ID” “tagA”  ”valueA”    ”tagB”  ”valueB”</li>
</ul>

<p><img src="/assets/awstag1.png" alt="image tooltip here" /></p>

<p><b> Create shell script to read the CSV file line by line, and add tags for each instance </b></p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">root@ubt-server:~# vim zacktag.sh

<span class="c">#!/bin/bash</span>

<span class="c"># Read the CSV file line by line</span>
<span class="k">while </span><span class="nv">IFS</span><span class="o">=</span>, <span class="nb">read</span> <span class="nt">-r</span> instance_id tagA valueA tagB valueB <span class="o">||</span> <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$instance_id</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">do</span>
    <span class="c"># Add tagA</span>
    aws ec2 create-tags <span class="nt">--resources</span> <span class="s2">"</span><span class="nv">$instance_id</span><span class="s2">"</span> <span class="nt">--tags</span> <span class="nv">Key</span><span class="o">=</span><span class="s2">"</span><span class="nv">$tagA</span><span class="s2">"</span>,Value<span class="o">=</span><span class="s2">"</span><span class="nv">$valueA</span><span class="s2">"</span>
    <span class="c"># Add tagB</span>
    aws ec2 create-tags <span class="nt">--resources</span> <span class="s2">"</span><span class="nv">$instance_id</span><span class="s2">"</span> <span class="nt">--tags</span> <span class="nv">Key</span><span class="o">=</span><span class="s2">"</span><span class="nv">$tagB</span><span class="s2">"</span>,Value<span class="o">=</span><span class="s2">"</span><span class="nv">$valueB</span><span class="s2">"</span>
<span class="k">done</span> &lt; zztag.csv

root@ubt-server:~# <span class="nb">chmod</span> +x zacktag.sh <span class="o">&amp;&amp;</span> sh zacktag.sh</code></pre></figure>

<ul>
  <li>Validate now ec2 instances with all tags attached</li>
</ul>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">root@ubt-server:~# aws ec2 describe-tags <span class="nt">--filters</span> <span class="s2">"Name=resource-id,Values=i-0980018fc6f4f722c"</span>
<span class="o">{</span>
    <span class="s2">"Tags"</span>: <span class="o">[</span>
        <span class="o">{</span>
            <span class="s2">"Key"</span>: <span class="s2">"Name"</span>,
            <span class="s2">"ResourceId"</span>: <span class="s2">"i-0980018fc6f4f722c"</span>,
            <span class="s2">"ResourceType"</span>: <span class="s2">"instance"</span>,
            <span class="s2">"Value"</span>: <span class="s2">"testing-for-tagging"</span>
        <span class="o">}</span>,
        <span class="o">{</span>
            <span class="s2">"Key"</span>: <span class="s2">"zz1"</span>,
            <span class="s2">"ResourceId"</span>: <span class="s2">"i-0980018fc6f4f722c"</span>,
            <span class="s2">"ResourceType"</span>: <span class="s2">"instance"</span>,
            <span class="s2">"Value"</span>: <span class="s2">"aa5"</span>
        <span class="o">}</span>,
        <span class="o">{</span>
            <span class="s2">"Key"</span>: <span class="s2">"zz2"</span>,
            <span class="s2">"ResourceId"</span>: <span class="s2">"i-0980018fc6f4f722c"</span>,
            <span class="s2">"ResourceType"</span>: <span class="s2">"instance"</span>,
            <span class="s2">"Value"</span>: <span class="s2">"bb4"</span>
        <span class="o">}</span>
    <span class="o">]</span>
<span class="o">}</span>
root@ubt-server:~# aws ec2 describe-tags <span class="nt">--filters</span> <span class="s2">"Name=resource-id,Values=i-076226daa5aaf7cf2"</span>
<span class="o">{</span>
    <span class="s2">"Tags"</span>: <span class="o">[</span>
        <span class="o">{</span>
            <span class="s2">"Key"</span>: <span class="s2">"Name"</span>,
            <span class="s2">"ResourceId"</span>: <span class="s2">"i-076226daa5aaf7cf2"</span>,
            <span class="s2">"ResourceType"</span>: <span class="s2">"instance"</span>,
            <span class="s2">"Value"</span>: <span class="s2">"zack-blog"</span>
        <span class="o">}</span>,
        <span class="o">{</span>
            <span class="s2">"Key"</span>: <span class="s2">"zz1"</span>,
            <span class="s2">"ResourceId"</span>: <span class="s2">"i-076226daa5aaf7cf2"</span>,
            <span class="s2">"ResourceType"</span>: <span class="s2">"instance"</span>,
            <span class="s2">"Value"</span>: <span class="s2">"aa1"</span>
        <span class="o">}</span>,
        <span class="o">{</span>
            <span class="s2">"Key"</span>: <span class="s2">"zz2"</span>,
            <span class="s2">"ResourceId"</span>: <span class="s2">"i-076226daa5aaf7cf2"</span>,
            <span class="s2">"ResourceType"</span>: <span class="s2">"instance"</span>,
            <span class="s2">"Value"</span>: <span class="s2">"aa2"</span>
        <span class="o">}</span>
    <span class="o">]</span>
<span class="o">}</span></code></pre></figure>

<p><img src="/assets/awstag3.png" alt="image tooltip here" /></p>

<ul>
  <li>create cronjob to update tagging monthly</li>
</ul>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># create a monthly script run job</span>
root@ubt-server:~# crontab <span class="nt">-e</span>
no crontab <span class="k">for </span>root - using an empty one

Select an editor.  To change later, run <span class="s1">'select-editor'</span><span class="nb">.</span>
  1. /bin/nano        &lt;<span class="nt">----</span> easiest
  2. /usr/bin/vim.basic
  3. /usr/bin/vim.tiny
  4. /bin/ed

Choose 1-4 <span class="o">[</span>1]: 2
crontab: installing new crontab

<span class="c"># List the monthly scheduled cronjob</span>
root@ubt-server:~# crontab <span class="nt">-l</span>
0 0 1 <span class="k">*</span> <span class="k">*</span> ~/zacktag.sh</code></pre></figure>

<p><b> Conclusion </b></p>

<p>Now we have a scripted way to achieve adding different tags for multiple ec2 instances via AWS CLI and shell script, same method to any other AWS resources that needed to be tagged, together with cronjob, we can only update the csv file which regularly updates resource ID and tags we want to attach, upload the csv file, every month their tags will be updated accordingly.</p>

  </div><a class="u-url" href="/jekyll/cat2/2024/05/01/AWS-tagging.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Zack&#39;s Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Zack&#39;s Blog</li><li><a class="u-email" href="mailto:zhbsoftboy1@gmail.com">zhbsoftboy1@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/ZackZhouHB"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">ZackZhouHB</span></a></li><li><a href="https://www.twitter.com/ZackZ"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">ZackZ</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>## AWS   ## Jenkins  ## Microservices ## Automation ## K8S   ## CICD     ## Gitops  [京ICP备2024056683号-1]</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
