<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Terraform Module for AWS SSO User Assignment | Zack’s Blog</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Terraform Module for AWS SSO User Assignment" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Challange About AWS SSO User Assignment" />
<meta property="og:description" content="Challange About AWS SSO User Assignment" />
<link rel="canonical" href="http://localhost:4000/jekyll/cat2/2024/05/20/terraform1.html" />
<meta property="og:url" content="http://localhost:4000/jekyll/cat2/2024/05/20/terraform1.html" />
<meta property="og:site_name" content="Zack’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-05-20T10:15:29+10:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Terraform Module for AWS SSO User Assignment" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-05-20T10:15:29+10:00","datePublished":"2024-05-20T10:15:29+10:00","description":"Challange About AWS SSO User Assignment","headline":"Terraform Module for AWS SSO User Assignment","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/jekyll/cat2/2024/05/20/terraform1.html"},"url":"http://localhost:4000/jekyll/cat2/2024/05/20/terraform1.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Zack&apos;s Blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Zack&#39;s Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/certificate/">Education &amp; Certificate</a><a class="page-link" href="/pro/">Work Experiences</a><a class="page-link" href="/skillroadmap/">Skill Roadmap</a><a class="page-link" href="/aboutme/">About Me</a><a class="page-link" href="/gitrepo/">Github Repos</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Terraform Module for AWS SSO User Assignment</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-05-20T10:15:29+10:00" itemprop="datePublished">May 20, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><b> Challange About AWS SSO User Assignment</b></p>

<p>In the company, we use AWS SSO for user management; when a new user is created from Azure AD, it will automatically synced into AWS Identity Center, and then our team will need to handle the SSO user assignment to put them in the required AWS accounts with requested permission sets, it became a pain when such requests coming more frequently and every time an individual user or a whole team with different accounts and permission requirements need to be fulfilled, so how to handle this efficiently become my recent topic.</p>

<p>So far, I have tried using shell script and Python script to read the user name, AWS account ID, and permission sets ARN from a CSV file, then complete the task with AWScli. However it is not smart enough when the request or scenario changes. I have to adjust the script everytime.</p>

<p><b> Terraform Modularity </b></p>

<p>Luckily, I found a solution to use Terraform module. There are many benefits to infrastructure as code with modularity. It can reduce code duplication, easy update, and have a clear code structure, which fits my AWS SSO user assignment task and challenge perfectly.</p>

<p>To achieve this, I will need:</p>

<ul>
  <li>A “main.tf” file to define the module; this allow the terraform code to be reusable and to handle SSO account assignments and manage each user scenario configuration easily</li>
</ul>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># modules/sso_account_assignment/main.tf</span>

variable <span class="s2">"sso_instance_arn"</span> <span class="o">{</span>
 description <span class="o">=</span> <span class="s2">"The ARN of the AWS SSO instance"</span>
 type    <span class="o">=</span> string
<span class="o">}</span>

variable <span class="s2">"account_id"</span> <span class="o">{</span>
 description <span class="o">=</span> <span class="s2">"The AWS account ID"</span>
 type    <span class="o">=</span> string
<span class="o">}</span>

variable <span class="s2">"users"</span> <span class="o">{</span>
 description <span class="o">=</span> <span class="s2">"List of users with their target IDs and permission set ARNs"</span>
 type    <span class="o">=</span> list<span class="o">(</span>object<span class="o">({</span>
  principal_id   <span class="o">=</span> string
  permission_set_arn <span class="o">=</span> string
 <span class="o">}))</span>
<span class="o">}</span>

resource <span class="s2">"aws_ssoadmin_account_assignment"</span> <span class="s2">"assignments"</span> <span class="o">{</span>
 for_each <span class="o">=</span> <span class="o">{</span> <span class="k">for </span>idx, user <span class="k">in </span>var.users : idx <span class="o">=&gt;</span> user <span class="o">}</span>

 instance_arn   <span class="o">=</span> var.sso_instance_arn
 target_id     <span class="o">=</span> var.account_id
 principal_id   <span class="o">=</span> each.value.principal_id
 principal_type  <span class="o">=</span> <span class="s2">"USER"</span>
 permission_set_arn <span class="o">=</span> each.value.permission_set_arn
<span class="o">}</span></code></pre></figure>

<ul>
  <li>A “main.tf” to create configuration to utilize the module, in here we will define the provider, and a few variables like “sso_instance_arn”, “sso_user_assignments” and “region”, also use “for_each” function to process each assignment. Then use “principal_id” and “permission_set_arn” to map user from the var list.</li>
</ul>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># main.tf</span>

provider <span class="s2">"aws"</span> <span class="o">{</span>
 region <span class="o">=</span> var.region
<span class="o">}</span>

variable <span class="s2">"sso_instance_arn"</span> <span class="o">{</span>
 description <span class="o">=</span> <span class="s2">"The ARN of the AWS SSO instance"</span>
 type    <span class="o">=</span> string
<span class="o">}</span>

variable <span class="s2">"assignments"</span> <span class="o">{</span>
 description <span class="o">=</span> <span class="s2">"Map of account IDs to users and their permission sets"</span>
 type    <span class="o">=</span> map<span class="o">(</span>list<span class="o">(</span>object<span class="o">({</span>
  principal_id   <span class="o">=</span> string
  permission_set_arn <span class="o">=</span> string
 <span class="o">})))</span>
<span class="o">}</span>

variable <span class="s2">"region"</span> <span class="o">{</span>
 description <span class="o">=</span> <span class="s2">"AWS region"</span>
 type    <span class="o">=</span> string
 default  <span class="o">=</span> <span class="s2">"ap-southeast-2"</span>
<span class="o">}</span>

module <span class="s2">"sso_account_assignments"</span> <span class="o">{</span>
 source <span class="o">=</span> <span class="s2">"./modules/sso_account_assignment"</span>

 for_each    <span class="o">=</span> var.assignments
 sso_instance_arn <span class="o">=</span> var.sso_instance_arn
 account_id   <span class="o">=</span> each.key
 users     <span class="o">=</span> each.value
<span class="o">}</span></code></pre></figure>

<ul>
  <li>A “terraform.tfvars” file to define and manage assignments using variables, here to define each unique assignment per request with each “target_id” and “permission_set_arn” to achieve dynamically assigning users to different accounts with various permission sets.</li>
</ul>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># terraform.tfvars</span>

sso_instance_arn <span class="o">=</span> <span class="s2">"arn:aws:sso:::instance/ssoins-a2oxxxxxxxxxxxc3"</span>

assignments <span class="o">=</span> <span class="o">{</span>
 <span class="s2">"2024-05-21-assginment"</span> <span class="o">=</span> <span class="o">[</span>
  <span class="o">{</span>
   target_id   <span class="o">=</span> <span class="s2">"user-david-development-team"</span>
   permission_set_arn <span class="o">=</span> <span class="s2">"arn:aws:sso:::permissionSet/ssoins-825xxxxxxxxxxaa/ps-6cxxxxxxxxxxe3"</span>
  <span class="o">}</span>,
  <span class="o">{</span>
   target_id   <span class="o">=</span> <span class="s2">"user-john-security-team"</span>
   permission_set_arn <span class="o">=</span> <span class="s2">"arn:aws:sso:::permissionSet/ssoins-825yyyyyyyyy0aa/ps-b06yyyyyyyyy7c4"</span>
  <span class="o">}</span>
 ],
 <span class="s2">"2024-05-23-assginment"</span> <span class="o">=</span> <span class="o">[</span>
  <span class="o">{</span>
   target_id   <span class="o">=</span> <span class="s2">"user-harry-servicedesk-team"</span>
   permission_set_arn <span class="o">=</span> <span class="s2">"arn:aws:sso:::permissionSet/ssoins-825zzzzzzzzzzaa/ps-611ezzzzzzzzz835"</span>
  <span class="o">}</span>
 ]
<span class="o">}</span></code></pre></figure>

<p><b> Conclusion</b></p>

<p>Now, we have a Terraform module to handle the creation of AWS SSO users more efficiently, dynamically, and reusable. In future we only define permission sets and maintain new users and assignment in the environment variables .tf file, then run terrafom apply to get the job done. The change also can be tracked when leveraging with Git as version control.</p>


  </div><a class="u-url" href="/jekyll/cat2/2024/05/20/terraform1.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Zack&#39;s Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Zack&#39;s Blog</li><li><a class="u-email" href="mailto:zhbsoftboy1@gmail.com">zhbsoftboy1@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/ZackZhouHB"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">ZackZhouHB</span></a></li><li><a href="https://www.twitter.com/ZackZ"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">ZackZ</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>## AWS   ## Jenkins  ## Microservices ## Automation ## K8S   ## CICD     ## Gitops  [京ICP备2024056683号-1]</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
