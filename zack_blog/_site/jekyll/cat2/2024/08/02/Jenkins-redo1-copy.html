<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Jenkins - Universal CI Pipeline with Ansible &amp; Terraform | Zack’s Blog</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Jenkins - Universal CI Pipeline with Ansible &amp; Terraform" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Jenkins recap" />
<meta property="og:description" content="Jenkins recap" />
<link rel="canonical" href="http://localhost:4000/jekyll/cat2/2024/08/02/Jenkins-redo1-copy.html" />
<meta property="og:url" content="http://localhost:4000/jekyll/cat2/2024/08/02/Jenkins-redo1-copy.html" />
<meta property="og:site_name" content="Zack’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-08-02T10:15:29+10:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Jenkins - Universal CI Pipeline with Ansible &amp; Terraform" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-08-02T10:15:29+10:00","datePublished":"2024-08-02T10:15:29+10:00","description":"Jenkins recap","headline":"Jenkins - Universal CI Pipeline with Ansible &amp; Terraform","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/jekyll/cat2/2024/08/02/Jenkins-redo1-copy.html"},"url":"http://localhost:4000/jekyll/cat2/2024/08/02/Jenkins-redo1-copy.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Zack&apos;s Blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Zack&#39;s Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/certificate/">Education &amp; Certificate</a><a class="page-link" href="/pro/">Work Experiences</a><a class="page-link" href="/skillroadmap/">Skill Roadmap</a><a class="page-link" href="/aboutme/">About Me</a><a class="page-link" href="/gitrepo/">Github Repos</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Jenkins - Universal CI Pipeline with Ansible &amp; Terraform</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-08-02T10:15:29+10:00" itemprop="datePublished">Aug 2, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><b>Jenkins recap</b></p>

<p>It has been some time since I adapted CI/CD pipelines from Jenkins to AWS CodePipeline and GitHub Actions workflows. Now, it’s time to recap and improve some of my previous Jenkins practices.</p>

<ul>
  <li>Universal Jenkins Docker image design</li>
</ul>

<p>This time, instead of installing Jenkins on a server, I prefer to containerize a universal Jenkins Docker image with the necessary packages installed, so it provides consistency and reproducibility, portability, and easy updates and rollbacks.</p>

<ol>
  <li>Docker CLI</li>
  <li>Terraform</li>
  <li>Kubectl</li>
  <li>Trivy</li>
  <li>AWS CLI</li>
  <li>Ansible </li>
</ol>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># Dockerfile</span>

FROM jenkins/jenkins:lts

USER root

<span class="c"># Install necessary packages, Docker CLI, Terraform, Kubectl, Trivy, AWS CLI, and Ansible</span>
RUN apt-get update <span class="o">&amp;&amp;</span> <span class="se">\</span>
    apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="se">\</span>
        curl <span class="se">\</span>
        wget <span class="se">\</span>
        unzip <span class="se">\</span>
        gnupg2 <span class="se">\</span>
        apt-transport-https <span class="se">\</span>
        lsb-release <span class="se">\</span>
        ca-certificates <span class="se">\</span>
        software-properties-common <span class="se">\</span>
        python3 <span class="se">\</span>
        python3-venv <span class="se">\</span>
        python3-pip <span class="o">&amp;&amp;</span> <span class="se">\</span>

    <span class="c"># Install Docker CLI</span>
    curl <span class="nt">-fsSL</span> https://download.docker.com/linux/debian/gpg | apt-key add - <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">echo</span> <span class="s2">"deb [arch=amd64] https://download.docker.com/linux/debian </span><span class="si">$(</span>lsb_release <span class="nt">-cs</span><span class="si">)</span><span class="s2"> stable"</span> <span class="o">&gt;</span> /etc/apt/sources.list.d/docker.list <span class="o">&amp;&amp;</span> <span class="se">\</span>
    apt-get update <span class="o">&amp;&amp;</span> <span class="se">\</span>
    apt-get <span class="nb">install</span> <span class="nt">-y</span> docker-ce-cli <span class="o">&amp;&amp;</span> <span class="se">\</span>

    <span class="c"># Install Terraform</span>
    wget <span class="nt">-O-</span> https://apt.releases.hashicorp.com/gpg | gpg <span class="nt">--dearmor</span> <span class="o">&gt;</span> /usr/share/keyrings/hashicorp-archive-keyring.gpg <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">echo</span> <span class="s2">"deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com </span><span class="si">$(</span>lsb_release <span class="nt">-cs</span><span class="si">)</span><span class="s2"> main"</span> <span class="o">&gt;</span> /etc/apt/sources.list.d/hashicorp.list <span class="o">&amp;&amp;</span> <span class="se">\</span>
    apt-get update <span class="o">&amp;&amp;</span> <span class="se">\</span>
    apt-get <span class="nb">install</span> <span class="nt">-y</span> terraform <span class="o">&amp;&amp;</span> <span class="se">\</span>

    <span class="c"># Install Kubectl</span>
    curl <span class="nt">-LO</span> <span class="s2">"https://dl.k8s.io/release/</span><span class="si">$(</span>curl <span class="nt">-L</span> <span class="nt">-s</span> https://dl.k8s.io/release/stable.txt<span class="si">)</span><span class="s2">/bin/linux/amd64/kubectl"</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">chmod</span> +x kubectl <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">mv </span>kubectl /usr/local/bin/ <span class="o">&amp;&amp;</span> <span class="se">\</span>

    <span class="c"># Install Trivy</span>
    wget https://github.com/aquasecurity/trivy/releases/download/v0.56.0/trivy_0.56.0_Linux-64bit.deb <span class="o">&amp;&amp;</span> <span class="se">\</span>
    dpkg <span class="nt">-i</span> trivy_0.56.0_Linux-64bit.deb <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">rm </span>trivy_0.56.0_Linux-64bit.deb <span class="o">&amp;&amp;</span> <span class="se">\</span>

    <span class="c"># Install AWS CLI</span>
    curl <span class="s2">"https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip"</span> <span class="nt">-o</span> <span class="s2">"awscliv2.zip"</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
    unzip awscliv2.zip <span class="o">&amp;&amp;</span> <span class="se">\</span>
    ./aws/install <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">rm</span> <span class="nt">-rf</span> awscliv2.zip aws/ <span class="o">&amp;&amp;</span> <span class="se">\</span>

    <span class="c"># Create a virtual environment for Python and Ansible</span>
    python3 <span class="nt">-m</span> venv /opt/ansible_venv <span class="o">&amp;&amp;</span> <span class="se">\</span>
    /opt/ansible_venv/bin/pip <span class="nb">install</span> <span class="nt">--upgrade</span> pip <span class="o">&amp;&amp;</span> <span class="se">\</span>
    /opt/ansible_venv/bin/pip <span class="nb">install </span>ansible <span class="o">&amp;&amp;</span> <span class="se">\</span>

    <span class="c"># Create symlinks to make Ansible easily accessible</span>
    <span class="nb">ln</span> <span class="nt">-s</span> /opt/ansible_venv/bin/ansible /usr/local/bin/ansible <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">ln</span> <span class="nt">-s</span> /opt/ansible_venv/bin/ansible-playbook /usr/local/bin/ansible-playbook <span class="o">&amp;&amp;</span> <span class="se">\</span>

    <span class="c"># Clean up</span>
    apt-get clean <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/apt/lists/<span class="k">*</span>

USER jenkins</code></pre></figure>

<p>Build and run this universal Jenkins image to mount Jenkins home directory and Docker socket from the host to the container, also add Docker group to the container so Jenkins can run Docker commands inside the container without needing root privileges.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">docker build <span class="nt">-t</span> jenkins-all <span class="nb">.</span>

docker run <span class="nt">-d</span> <span class="nt">--name</span> jenkins <span class="nt">-p</span> 8080:8080 <span class="nt">-p</span> 50000:50000 <span class="se">\</span>
<span class="nt">-v</span> /var/run/docker.sock:/var/run/docker.sock <span class="se">\</span>
<span class="nt">-v</span> /var/jenkins_home:/var/jenkins_home <span class="se">\</span>
<span class="nt">--group-add</span> <span class="si">$(</span>getent group docker | <span class="nb">cut</span> <span class="nt">-d</span>: <span class="nt">-f3</span><span class="si">)</span> <span class="se">\ </span>
jenkins-all</code></pre></figure>

<ul>
  <li>Universal Jenkins CI pipeline design</li>
</ul>

<p>After installing a list of plugins and configuring all credentials and the GitHub webhook, the CI pipeline is designed bellow and can be triggered by a Git push event and will run automatically:</p>

<ol>
  <li>Enable multi-language artifact build support.</li>
  <li>Integrate testing of Java versions.</li>
  <li>Enable security checks for static code analysis and Docker image scanning.</li>
  <li>Implement advanced Jenkins pipeline structuring using <b>try-catch</b>, <b>if-else</b>, <b>timeouts</b>,<b>environment variables</b>,<b>post actions</b> and <b>error handling</b>.</li>
</ol>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c">#  Jenkinsfile</span>

// Define the detectJavaVersion <span class="k">function </span>outside of the pipeline block
def detectJavaVersion<span class="o">()</span> <span class="o">{</span>
    def javaVersionOutput <span class="o">=</span> sh<span class="o">(</span>script: <span class="s1">'java -version 2&gt;&amp;1'</span>, returnStatus: <span class="nb">false</span>, returnStdout: <span class="nb">true</span><span class="o">)</span>.trim<span class="o">()</span>
    def javaVersionMatch <span class="o">=</span> javaVersionOutput <span class="o">=</span>~ /openjdk version <span class="s2">"(</span><span class="se">\d</span><span class="s2">+</span><span class="se">\.\d</span><span class="s2">+)/

    if (javaVersionMatch) {
        def javaVersion = javaVersionMatch[0][1]

        if (javaVersion.startsWith("</span>1.8<span class="s2">")) {
            return '8'
        } else if (javaVersion.startsWith("</span>11<span class="s2">")) {
            return '11'
        } else if (javaVersion.startsWith("</span>17<span class="s2">")) {
            return '17'
        } else {
            error("</span>Unsupported Java version detected: <span class="k">${</span><span class="nv">javaVersion</span><span class="k">}</span><span class="s2">")
        }
    } else {
        error("</span>Java version information not found <span class="k">in </span>output.<span class="s2">")
    }
}

pipeline {
    agent any
    environment {
        REGISTRY_URL = 'https://index.docker.io/v1/'
        IMAGE_NAME = "</span>zackz001/jenkins<span class="s2">"
        IMAGE_TAG = "</span><span class="k">${</span><span class="nv">env</span><span class="p">.BUILD_NUMBER</span><span class="k">}</span><span class="s2">"
        LATEST_TAG = "</span>latest<span class="s2">"
        TRIVY_OUTPUT = "</span>trivy-report.txt<span class="s2">"
        EMAIL_RECIPIENT = "</span>zhbsoftboy1@gmail.com<span class="s2">"
        GIT_REPO_URL = 'https://github.com/ZackZhouHB/zack-gitops-project.git'  // Git repository URL
        GIT_BRANCH = 'jenkins'  // Git branch
        DOCKERHUB_CREDENTIALS_ID = 'dockerhub' // Docker Hub credentials
        SONAR_TOKEN = 'sonar'  // Fetch Sonar token securely
        SNYK_INSTALLATION = 'snyk' // Replace with your Snyk installation
        SNYK_TOKEN = 'snyktoken'  // Fetch Snyk token securely
    }
    stages {
        stage('Clean Workspace') {
            steps {
                cleanWs()
            }
        }   
        stage('Checkout Code') {
            steps {
                git branch: "</span><span class="k">${</span><span class="nv">GIT_BRANCH</span><span class="k">}</span><span class="s2">",
                    credentialsId: 'gittoken',
                    url: "</span><span class="k">${</span><span class="nv">GIT_REPO_URL</span><span class="k">}</span><span class="s2">"
            }   
        }
        stage('Detect and Set Java') {
            steps {
                script {
                    try {
                        def javaVersion = detectJavaVersion()  // Detect the Java version, e.g., "</span>17<span class="s2">"
                        def javaToolName = "</span>Java_<span class="k">${</span><span class="nv">javaVersion</span><span class="k">}</span><span class="s2">"  // Expected tool name

                        // Try to set the Java version; fallback if the specific version isn't found
                        try {
                            tool name: javaToolName, type: 'jdk'
                            echo "</span>Using Java version <span class="k">${</span><span class="nv">javaVersion</span><span class="k">}</span>.<span class="s2">"
                        } catch (Exception toolError) {
                            echo "</span>No JDK named <span class="k">${</span><span class="nv">javaToolName</span><span class="k">}</span> found. Using default JDK.<span class="s2">"
                        }

                        // Verify Java version, regardless of whether the specific version was found
                        sh 'java --version'

                    } catch (Exception e) {
                        echo "</span>Error during Java version detection: <span class="k">${</span><span class="nv">e</span><span class="p">.message</span><span class="k">}</span><span class="s2">"
                        // Continue pipeline even if Java detection fails
                    }
                }
            }
        }
        // for Code Security Analysis and Fixes
        stage('snyk_analysis') {
            steps {
                script {
                    echo 'Running Snyk security analysis...'
                    timeout(time: 5, unit: 'MINUTES') {  // Adjust the timeout value as necessary
                        try {
                            snykSecurity(
                                snykInstallation: SNYK_INSTALLATION,
                                snykTokenId: SNYK_TOKEN,
                                failOnIssues: false,
                                monitorProjectOnBuild: true,
                                additionalArguments: '--severity-threshold=low'
                            )
                       } catch (Exception e) {
                            currentBuild.result = 'FAILURE'
                            error("</span>Error during snyk_analysis: <span class="k">${</span><span class="nv">e</span><span class="p">.message</span><span class="k">}</span><span class="s2">")
                        }
                    }
                }
            }
        }
        
        // Language-specific build and test stages
        stage('Frontend Build and Test') {
            steps {
                script {
                    try {
                        if (fileExists('package.json')) {
                            sh 'npm install --force'
                            sh 'npm test'
                        } else {
                            echo 'No package.json found, skipping Frontend build and test.'
                        }
                    } catch (Exception e) {
                        currentBuild.result = 'FAILURE'
                        error("</span>Error during Frontend build and <span class="nb">test</span>: <span class="k">${</span><span class="nv">e</span><span class="p">.message</span><span class="k">}</span><span class="s2">")
                    }
                }
            }
        }

        stage('Java Spring Boot Build and Test') {
            steps {
                script {
                    try {
                        if (fileExists('pom.xml')) {
                            sh 'mvn clean package'
                            sh 'mvn test'
                        } else {
                            echo 'No pom.xml found, skipping Java Spring Boot build and test.'
                        }
                    } catch (Exception e) {
                        currentBuild.result = 'FAILURE'
                        error("</span>Error during Java Spring Boot build and <span class="nb">test</span>: <span class="k">${</span><span class="nv">e</span><span class="p">.message</span><span class="k">}</span><span class="s2">")
                    }
                }
            }
        }

        stage('.NET Build and Test') {
            steps {
                script {
                    try {
                        if (fileExists('YourSolution.sln')) {
                            sh 'dotnet build'
                            sh 'dotnet test'
                        } else {
                            echo 'No YourSolution.sln found, skipping .NET build and test.'
                        }
                    } catch (Exception e) {
                        currentBuild.result = 'FAILURE'
                        error("</span>Error during .NET build and <span class="nb">test</span>: <span class="k">${</span><span class="nv">e</span><span class="p">.message</span><span class="k">}</span><span class="s2">")
                    }
                }
            }
        }

        stage('PHP Build and Test') {
            steps {
                script {
                    try {
                        if (fileExists('composer.json')) {
                            sh 'composer install'
                            sh 'phpunit'
                        } else {
                            echo 'No composer.json found, skipping PHP build and test.'
                        }
                    } catch (Exception e) {
                        currentBuild.result = 'FAILURE'
                        error("</span>Error during PHP build and <span class="nb">test</span>: <span class="k">${</span><span class="nv">e</span><span class="p">.message</span><span class="k">}</span><span class="s2">")
                    }
                }
            }
        }

        stage('iOS Build and Test') {
            steps {
                script {
                    try {
                        if (fileExists('YourProject.xcodeproj')) {
                            xcodebuild(buildDir: 'build', scheme: 'YourScheme')
                        } else {
                            echo 'No YourProject.xcodeproj found, skipping iOS build and test.'
                        }
                    } catch (Exception e) {
                        currentBuild.result = 'FAILURE'
                        error("</span>Error during iOS build and <span class="nb">test</span>: <span class="k">${</span><span class="nv">e</span><span class="p">.message</span><span class="k">}</span><span class="s2">")
                    }
                }
            }
        }

        stage('Android Build and Test') {
            steps {
                script {
                    try {
                        if (fileExists('build.gradle')) {
                            sh './gradlew build'
                            sh './gradlew test'
                        } else {
                            echo 'No build.gradle found, skipping Android build and test.'
                        }
                    } catch (Exception e) {
                        currentBuild.result = 'FAILURE'
                        error("</span>Error during Android build and <span class="nb">test</span>: <span class="k">${</span><span class="nv">e</span><span class="p">.message</span><span class="k">}</span><span class="s2">")
                    }
                }
            }
        }

        stage('Ruby on Rails Build and Test') {
            steps {
                script {
                    try {
                        if (fileExists('Gemfile.lock')) {
                            sh 'bundle install'
                            sh 'bundle exec rake db:migrate'
                            sh 'bundle exec rails test'
                        } else {
                            echo 'No Gemfile.lock found, skipping Ruby on Rails build and test.'
                        }
                    } catch (Exception e) {
                        currentBuild.result = 'FAILURE'
                        error("</span>Error during Ruby on Rails build and <span class="nb">test</span>: <span class="k">${</span><span class="nv">e</span><span class="p">.message</span><span class="k">}</span><span class="s2">")
                    }
                }
            }
        }

        stage('Flask Build and Test') {
            steps {
                script {
                    try {
                        if (fileExists('app.py')) {
                            sh 'pip install -r requirements.txt'
                            sh 'python -m unittest discover'
                        } else {
                            echo 'No app.py found, skipping Flask build and test.'
                        }
                    } catch (Exception e) {
                        currentBuild.result = 'FAILURE'
                        error("</span>Error during Flask build and <span class="nb">test</span>: <span class="k">${</span><span class="nv">e</span><span class="p">.message</span><span class="k">}</span><span class="s2">")
                    }
                }
            }
        }

        stage('Django Build and Test') {
            steps {
                script {
                    try {
                        if (fileExists('manage.py')) {
                            sh 'pip install -r requirements.txt'
                            sh 'python manage.py migrate'
                            sh 'python manage.py test'
                        } else {
                            echo 'No manage.py found, skipping Django build and test.'
                        }
                    } catch (Exception e) {
                        currentBuild.result = 'FAILURE'
                        error("</span>Error during Django build and <span class="nb">test</span>: <span class="k">${</span><span class="nv">e</span><span class="p">.message</span><span class="k">}</span><span class="s2">")
                    }
                }
            }
        }

        stage('Rust Build and Test') {
            steps {
                script {
                    try {
                        if (fileExists('Cargo.toml')) {
                            env.RUST_BACKTRACE = 'full'
                            sh 'cargo build'
                            sh 'cargo test'
                        } else {
                            echo "</span>No Cargo.toml file found. Skipping Rust build and test.<span class="s2">"
                        }
                    } catch (Exception e) {
                        currentBuild.result = 'FAILURE'
                        error("</span>Error during Rust build and <span class="nb">test</span>: <span class="k">${</span><span class="nv">e</span><span class="p">.message</span><span class="k">}</span><span class="s2">")
                    }
                }
            }
        }

        stage('Ruby Sinatra Build and Test') {
            steps {
                script {
                    try {
                        if (fileExists('app.rb')) {
                            sh 'gem install bundler'
                            sh 'bundle install'
                            sh 'bundle exec rake test'
                        } else {
                            echo "</span>No app.rb file found. Skipping Ruby Sinatra build and test.<span class="s2">"
                        }
                    } catch (Exception e) {
                        currentBuild.result = 'FAILURE'
                        error("</span>Error during Ruby Sinatra build and <span class="nb">test</span>: <span class="k">${</span><span class="nv">e</span><span class="p">.message</span><span class="k">}</span><span class="s2">")
                    }
                }
            }
        }
        // Build ZackBlog docker image 
        stage('Check and Build Docker Image') {
            steps {
                script {
                    try {
                        // Check if Docker is available
                        sh 'docker --version'
                        echo "</span>Docker is installed. Proceeding to build the Docker image...<span class="s2">"
                        
                        // Build the Docker image from the 'zack_blog' folder
                        dockerImage = docker.build("</span><span class="k">${</span><span class="nv">IMAGE_NAME</span><span class="k">}</span>:<span class="k">${</span><span class="nv">IMAGE_TAG</span><span class="k">}</span><span class="s2">", "</span>zack_blog/<span class="s2">")
                    } catch (Exception e) {
                        // Handle the error if Docker is not available
                        error("</span>Docker is not installed or accessible. Cannot proceed with the build.<span class="s2">")
                    }
                }
            }
        }
        // Scan docker image with Trivy
        stage('Docker Image Scan') {
            steps {
                // Use Trivy to scan the built Docker image
                sh "</span>trivy image <span class="nt">--severity</span> HIGH,CRITICAL <span class="k">${</span><span class="nv">IMAGE_NAME</span><span class="k">}</span>:<span class="k">${</span><span class="nv">IMAGE_TAG</span><span class="k">}</span> <span class="o">&gt;</span> <span class="k">${</span><span class="nv">TRIVY_OUTPUT</span><span class="k">}</span><span class="s2">"
            }
        }
        //Push to Dockerhub
        stage('Push Docker Image to DockerHub') {
            steps {
                script {
                    docker.withRegistry("</span><span class="k">${</span><span class="nv">REGISTRY_URL</span><span class="k">}</span><span class="s2">", "</span><span class="k">${</span><span class="nv">DOCKERHUB_CREDENTIALS_ID</span><span class="k">}</span><span class="s2">") {
                        dockerImage.push("</span><span class="k">${</span><span class="nv">IMAGE_TAG</span><span class="k">}</span><span class="s2">")
                        dockerImage.push("</span><span class="k">${</span><span class="nv">LATEST_TAG</span><span class="k">}</span><span class="s2">") // Push 'latest' tag
                    }
                }
            }
        }
        //Output image scan result
        stage('Display Trivy Scan Results') {
            steps {
                script {
                    // Display the contents of the Trivy report
                    def scanReport = readFile("</span><span class="k">${</span><span class="nv">TRIVY_OUTPUT</span><span class="k">}</span><span class="s2">")
                    echo "</span>Trivy Scan Report:<span class="se">\n</span><span class="k">${</span><span class="nv">scanReport</span><span class="k">}</span><span class="s2">"
                }
            }
        }
        // Additional stages like Docker build, image scan, etc.
    }
    // Post Build Emailing 
    post {
        success {
            script {
                def scanReport = readFile("</span><span class="k">${</span><span class="nv">TRIVY_OUTPUT</span><span class="k">}</span><span class="s2">")
                emailext(
                    to: "</span><span class="k">${</span><span class="nv">EMAIL_RECIPIENT</span><span class="k">}</span><span class="s2">",
                    subject: "</span>CI Pipeline Success: Build <span class="k">${</span><span class="nv">IMAGE_TAG</span><span class="k">}</span><span class="s2">",
                    body: """</span>
                    The pipeline has successfully completed.

                    Docker image <span class="k">${</span><span class="nv">IMAGE_NAME</span><span class="k">}</span>:<span class="k">${</span><span class="nv">IMAGE_TAG</span><span class="k">}</span> has been built and pushed to DockerHub.

                    Trivy Scan Report:
                    <span class="k">${</span><span class="nv">scanReport</span><span class="k">}</span>
                    <span class="s2">"""
                )
            }
        }
        failure {
            emailext(
                to: "</span><span class="k">${</span><span class="nv">EMAIL_RECIPIENT</span><span class="k">}</span><span class="s2">",
                subject: "</span>CI Pipeline Failed: Build <span class="k">${</span><span class="nv">IMAGE_TAG</span><span class="k">}</span><span class="s2">",
                body: """</span>
                The pipeline has failed at some stage.

                Please check the Jenkins console logs <span class="k">for </span>more details.
                <span class="s2">"""
            )
        }
    }
}</span></code></pre></figure>

<ul>
  <li>Pipeline test and debug</li>
</ul>

<p>After thorough testing and validation, the CI pipeline finally works like a charm.</p>

<p><img src="/assets/jenkins1.png" alt="image tooltip here" /></p>

<p>Next, I will create a CD pipeline to integrate with Ansible, AWS, and Terraform to deploy the blog onto AWS EC2, ECS, and EKS.</p>


  </div><a class="u-url" href="/jekyll/cat2/2024/08/02/Jenkins-redo1-copy.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Zack&#39;s Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Zack&#39;s Blog</li><li><a class="u-email" href="mailto:zhbsoftboy1@gmail.com">zhbsoftboy1@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/ZackZhouHB"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">ZackZhouHB</span></a></li><li><a href="https://www.twitter.com/ZackZ"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">ZackZ</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>## AWS   ## Jenkins  ## Microservices ## Automation ## K8S   ## CICD     ## Gitops </p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
