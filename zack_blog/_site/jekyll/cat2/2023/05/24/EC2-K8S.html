<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Kubespary with Terraform on AWS | Zack’s Blog</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Kubespary with Terraform on AWS" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="About Kubespary" />
<meta property="og:description" content="About Kubespary" />
<link rel="canonical" href="http://localhost:4000/jekyll/cat2/2023/05/24/EC2-K8S.html" />
<meta property="og:url" content="http://localhost:4000/jekyll/cat2/2023/05/24/EC2-K8S.html" />
<meta property="og:site_name" content="Zack’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-05-24T10:15:29+10:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Kubespary with Terraform on AWS" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-05-24T10:15:29+10:00","datePublished":"2023-05-24T10:15:29+10:00","description":"About Kubespary","headline":"Kubespary with Terraform on AWS","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/jekyll/cat2/2023/05/24/EC2-K8S.html"},"url":"http://localhost:4000/jekyll/cat2/2023/05/24/EC2-K8S.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Zack&apos;s Blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Zack&#39;s Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/certificate/">Education &amp; Certificate</a><a class="page-link" href="/pro/">Work Experiences</a><a class="page-link" href="/skillroadmap/">Skill Roadmap</a><a class="page-link" href="/aboutme/">About Me</a><a class="page-link" href="/gitrepo/">Github Repos</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Kubespary with Terraform on AWS </h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2023-05-24T10:15:29+10:00" itemprop="datePublished">May 24, 2023
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><b> About Kubespary</b></p>

<p>Kubespary is a powerful and highly configurable tool that automates and supports deployment on various cloud providers (AWS, GCE, Azure, etc.) and on-premises infrastructure. In this post I will run its build-in Terraform and ansible code to provision a k8s cluster based on AWS EC2.</p>

<p><b> Benefit of Kubespary</b></p>

<p>We can define specific settings in <code class="language-plaintext highlighter-rouge">cluster-config.yaml</code> for networking, authentication, and other Kubernetes features, it also supports for multiple networking plugins (Calico, Flannel, Weave Net, etc.), By managing hosts file and rerun the playbook to make add or remove nodes easily, Integrated CI/CD Pipelines and Infrastructure as Code (IaC) with Terraform and Ansible to achieve automation.</p>

<p><b>Kubespary on Local Lab</b></p>

<p>In local machine, ensure</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Git</code>, <code class="language-plaintext highlighter-rouge">Ansible</code>, <code class="language-plaintext highlighter-rouge">Python</code>, <code class="language-plaintext highlighter-rouge">Terraform</code> installed</p>
  </li>
  <li>
    <p>5 VM ready with ssh configured</p>
  </li>
  <li>
    <p>clone the Kubespray git repo in a python vritual environment to install Kubespray required packages based on its <code class="language-plaintext highlighter-rouge">requirements.txt</code> file</p>
  </li>
  <li>
    <p>create a local folder under inventory <code class="language-plaintext highlighter-rouge">homelab-k8s</code>, create a <code class="language-plaintext highlighter-rouge">hosts.yaml</code> to define the local nodes, create a <code class="language-plaintext highlighter-rouge">cluster-config.yaml</code> to define specific cofiguration of the k8s cluster</p>
  </li>
  <li>
    <p>run the playbook to have a k8s cluster ready to use</p>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># ensure 5 vms ready with ssh</span>
ssh-keygen <span class="nt">-t</span> rsa <span class="nt">-b</span> 2048
ssh-copy-id ubuntu@11.0.1.121  <span class="c"># Repeat for other VMs</span>

<span class="c"># clone kubespray repo</span>
git clone https://github.com/kubernetes-sigs/kubespray.git

<span class="c"># create a python virtual environment</span>
python3 <span class="nt">-m</span> venv kubespray-venv
<span class="nb">source </span>kubespray-venv/bin/activate

<span class="c"># install kubespray required packages</span>
<span class="nb">cd </span>kubespray
pip <span class="nb">install</span> <span class="nt">-U</span> <span class="nt">-r</span> requirements.txt

<span class="c">#  create a local folder under inventory, manage hosts and cluster configure</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> inventory/homelab-k8s

vim inventory/homelab-k8s/hosts.yaml

all:
  hosts:
    node1:
      ansible_host: 11.0.1.121
      ip: 11.0.1.121
    node2:
      ansible_host: 11.0.1.122
      ip: 11.0.1.122
    node3:
      ansible_host: 11.0.1.123
      ip: 11.0.1.123
    node4:
      ansible_host: 11.0.1.124
      ip: 11.0.1.124
    node5:
      ansible_host: 11.0.1.125
      ip: 11.0.1.125
  children:
    kube_control_plane:
      hosts:
        node1:
    kube_node:
      hosts:
        node2:
        node3:
        node4:
        node5:
    etcd:
      hosts:
        node1:
        node2:
        node3:
    k8s_cluster:
      children:
        kube_control_plane:
        kube_node:
    calico_rr:
      hosts: <span class="o">{}</span>


vim inventory/homelab-k8s/cluster-config.yaml

cluster_name: kubespray-k8s
kube_version: v1.30.4

<span class="c"># run  the playbook to create the cluster </span>
ansible-playbook <span class="nt">-i</span> inventory/homelab-k8s/hosts.yaml <span class="nt">-e</span> inventory/homelab-k8s/cluster-config.yaml <span class="se">\</span>
<span class="nt">--user</span><span class="o">=</span>ubuntu <span class="se">\</span>
<span class="nt">--become</span> <span class="se">\</span>
<span class="nt">--become-user</span><span class="o">=</span>root <span class="se">\</span>
cluster.yml</code></pre></figure>

<p>Ansible will execute for 15-20mins, then a cluster is ready</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">ubuntu@node1:~<span class="nv">$ </span>kubectl get node <span class="nt">-o</span> wide
NAME    STATUS   ROLES           AGE    VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME
node1   Ready    control-plane    28m   v1.31.1   11.0.1.121    &lt;none&gt;        Ubuntu 22.04.4 LTS   5.15.0-97-generic   containerd://1.7.22
node2   Ready    &lt;none&gt;           28m   v1.31.1   11.0.1.122    &lt;none&gt;        Ubuntu 22.04.4 LTS   5.15.0-97-generic   containerd://1.7.22
node3   Ready    &lt;none&gt;           28m   v1.31.1   11.0.1.123    &lt;none&gt;        Ubuntu 22.04.4 LTS   5.15.0-97-generic   containerd://1.7.22
node4   Ready    &lt;none&gt;           28m   v1.31.1   11.0.1.124    &lt;none&gt;        Ubuntu 22.04.4 LTS   5.15.0-97-generic   containerd://1.7.22
node5   Ready    &lt;none&gt;           28m   v1.31.1   11.0.1.125    &lt;none&gt;        Ubuntu 22.04.4 LTS   5.15.0-97-generic   containerd://1.7.22</code></pre></figure>

<p><b>Kubespray on AWS EC2 with Terraform</b></p>

<p>now let’s move to cloud practice on AWS with Kubespray,</p>

<ul>
  <li>
    <p>Move to terraform aws folder, fill out <code class="language-plaintext highlighter-rouge">credentials.tfvars</code> with our AWS credentials</p>
  </li>
  <li>
    <p>Fill desired cluster config like instance type, count and AMI in <code class="language-plaintext highlighter-rouge">terraform.tfvars</code></p>
  </li>
  <li>
    <p>Create 1 ec2 master node and 1 ec2 worker node using terraform.</p>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nb">cd </span>kubespray/contrib/terraform/aws/

<span class="c">#AWS Access Key</span>
AWS_ACCESS_KEY_ID <span class="o">=</span> <span class="s2">"zzzz"</span>
<span class="c">#AWS Secret Key</span>
AWS_SECRET_ACCESS_KEY <span class="o">=</span> <span class="s2">"zzzz"</span>
<span class="c">#EC2 SSH Key Name</span>
AWS_SSH_KEY_NAME <span class="o">=</span> <span class="s2">"zzzzzzzzzz"</span>
<span class="c">#AWS Region</span>
AWS_DEFAULT_REGION <span class="o">=</span> <span class="s2">"ap-southeast-2"</span>

vim terraform.tfvars

<span class="c">#Global Vars</span>
aws_cluster_name <span class="o">=</span> <span class="s2">"zack-ec2-k8s-cluster-via-kubespray"</span>

<span class="c">#VPC Vars</span>
aws_vpc_cidr_block       <span class="o">=</span> <span class="s2">"10.250.192.0/18"</span>
aws_cidr_subnets_private <span class="o">=</span> <span class="o">[</span><span class="s2">"10.250.192.0/20"</span>, <span class="s2">"10.250.208.0/20"</span><span class="o">]</span>
aws_cidr_subnets_public  <span class="o">=</span> <span class="o">[</span><span class="s2">"10.250.224.0/20"</span>, <span class="s2">"10.250.240.0/20"</span><span class="o">]</span>

<span class="c">#Bastion Host</span>
aws_bastion_size <span class="o">=</span> <span class="s2">"t2.micro"</span>

<span class="c">#Kubernetes Cluster</span>

aws_kube_master_num  <span class="o">=</span> 1
aws_kube_master_size <span class="o">=</span> <span class="s2">"t3.small"</span>

aws_etcd_num  <span class="o">=</span> 3
aws_etcd_size <span class="o">=</span> <span class="s2">"t2.medium"</span>

aws_kube_worker_num  <span class="o">=</span> 1
aws_kube_worker_size <span class="o">=</span> <span class="s2">"t3.small"</span>

<span class="c">#Settings AWS ELB</span>

aws_elb_api_port                <span class="o">=</span> 6443
k8s_secure_api_port             <span class="o">=</span> 6443
kube_insecure_apiserver_address <span class="o">=</span> <span class="s2">"0.0.0.0"</span>

default_tags <span class="o">=</span> <span class="o">{</span>
  <span class="c">#  Env = "devtest"</span>
  <span class="c">#  Product = "kubernetes"</span>
<span class="o">}</span>

inventory_file <span class="o">=</span> <span class="s2">"../../../inventory/hosts"</span>

<span class="c"># create ec2 by terraform</span>
terraform init
terraform plan <span class="nt">-var-file</span><span class="o">=</span>credentials.tfvars
terraform apply <span class="nt">-var-file</span><span class="o">=</span>credentials.tfvars

<span class="c"># Terraform output</span>
aws_nlb_api_fqdn <span class="o">=</span> <span class="s2">"kubernetes-nlb-devtest-a9cae6ee92bc1b6e.elb.ap-southeast-2.amazonaws.com:6443"</span>
bastion_ip <span class="o">=</span> <span class="s2">"54.206.92.197"</span>
default_tags <span class="o">=</span> tomap<span class="o">({})</span>
etcd <span class="o">=</span> <span class="s2">"10.250.202.194"</span>
inventory <span class="o">=</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">
[all]
ip-10-250-202-194.ap-southeast-2.compute.internal ansible_host=10.250.202.194
ip-10-250-196-14.ap-southeast-2.compute.internal ansible_host=10.250.196.14

bastion ansible_host=54.206.92.197

[bastion]
bastion ansible_host=54.206.92.197

[kube_control_plane]
ip-10-250-202-194.ap-southeast-2.compute.internal

[kube_node]
ip-10-250-196-14.ap-southeast-2.compute.internal

[etcd]
ip-10-250-202-194.ap-southeast-2.compute.internal

[calico_rr]

[k8s_cluster:children]
kube_node
kube_control_plane
calico_rr

[k8s_cluster:vars]
apiserver_loadbalancer_domain_name="kubernetes-nlb-devtest-a9cae6ee92bc1b6e.elb.ap-southeast-2.amazonaws.com"
</span><span class="no">
EOT
</span>masters <span class="o">=</span> <span class="s2">"10.250.202.194"</span>
workers <span class="o">=</span> <span class="s2">"10.250.196.14"</span></code></pre></figure>

<p>Ansible will pass the ec2 ip into kubespray hosts file, lets verify the hosts file is correct, configure ssh key agent so the playbook can communicate with AWS ec2, then  run the playbook to install kubernetes cluster.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># verify hosts</span>
<span class="nb">cd</span> ~/kubespray
<span class="nb">cat </span>inventory/hosts

<span class="c"># enable ssh key agent</span>
<span class="nb">cat</span> “” <span class="o">&gt;</span> ~/.ssh/zzz.pem
<span class="nb">eval</span> <span class="si">$(</span>ssh-agent<span class="si">)</span>
ssh-add <span class="nt">-D</span>
ssh-add ~/.ssh/zzz.pem

<span class="c"># execute playbook to deploy k8s cluster</span>
ansible-playbook <span class="nt">-i</span> ./inventory/hosts ./cluster.yml <span class="nt">-e</span> <span class="nv">ansible_user</span><span class="o">=</span>ubuntu <span class="nt">-b</span> <span class="nt">--become-user</span><span class="o">=</span>root

PLAY RECAP <span class="k">**************************************************************************************************************************</span>
bastion                    : <span class="nv">ok</span><span class="o">=</span>7    <span class="nv">changed</span><span class="o">=</span>2    <span class="nv">unreachable</span><span class="o">=</span>0    <span class="nv">failed</span><span class="o">=</span>0    <span class="nv">skipped</span><span class="o">=</span>3    <span class="nv">rescued</span><span class="o">=</span>0    <span class="nv">ignored</span><span class="o">=</span>0   
ip-10-250-196-14.ap-southeast-2.compute.internal : <span class="nv">ok</span><span class="o">=</span>464  <span class="nv">changed</span><span class="o">=</span>94   <span class="nv">unreachable</span><span class="o">=</span>0    <span class="nv">failed</span><span class="o">=</span>0    <span class="nv">skipped</span><span class="o">=</span>749  <span class="nv">rescued</span><span class="o">=</span>0    <span class="nv">ignored</span><span class="o">=</span>1   
ip-10-250-202-194.ap-southeast-2.compute.internal : <span class="nv">ok</span><span class="o">=</span>591  <span class="nv">changed</span><span class="o">=</span>139  <span class="nv">unreachable</span><span class="o">=</span>0    <span class="nv">failed</span><span class="o">=</span>0    <span class="nv">skipped</span><span class="o">=</span>989  <span class="nv">rescued</span><span class="o">=</span>0    <span class="nv">ignored</span><span class="o">=</span>6   

Thursday 10 October 2024  05:06:02 +0000 <span class="o">(</span>0:00:00.072<span class="o">)</span>       0:11:11.596 <span class="k">******</span> 
<span class="o">===============================================================================</span> </code></pre></figure>

<p>now we can access the cluster by ssh into master node via bastion host. lets verify the cluster is up and running.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># configure kubeconfig to manage cluster</span>
ubuntu@ip-10-250-202-194:~<span class="nv">$ </span><span class="nb">mkdir</span> <span class="nt">-p</span> /home/ubuntu/.kube
ubuntu@ip-10-250-202-194:~<span class="nv">$ </span><span class="nb">sudo cp</span> /etc/kubernetes/admin.conf /home/ubuntu/.kube/config
ubuntu@ip-10-250-202-194:~<span class="nv">$ </span><span class="nb">sudo chown </span>ubuntu:ubuntu /home/ubuntu/.kube/config
ubuntu@ip-10-250-202-194:~<span class="nv">$ </span>kubectl get nodes
NAME                                                STATUS   ROLES           AGE   VERSION
ip-10-250-196-14.ap-southeast-2.compute.internal    Ready    &lt;none&gt;          22m   v1.31.1
ip-10-250-202-194.ap-southeast-2.compute.internal   Ready    control-plane   22m   v1.31.1</code></pre></figure>

<p><b>Conclusion</b></p>

<p>Now we are able to create k8s cluster using Kubespray locally and with cloud providers like AWS, The combination of automated deployment, cloud infrastructure management, offers me hands-on experience and valuable skills for building and maintaining scalable, secure applications in diverse environments.  This is a great starting point for anyone looking to explore Kubernetes and cloud computing. I hope this tutorial has been helpful in anyone’s journey to learn Kubernetes and cloud computing.</p>

  </div><a class="u-url" href="/jekyll/cat2/2023/05/24/EC2-K8S.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Zack&#39;s Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Zack&#39;s Blog</li><li><a class="u-email" href="mailto:zhbsoftboy1@gmail.com">zhbsoftboy1@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/ZackZhouHB"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">ZackZhouHB</span></a></li><li><a href="https://www.twitter.com/ZackZ"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">ZackZ</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>## AWS   ## Jenkins  ## Microservices ## Automation ## K8S   ## CICD     ## Gitops </p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
