---
layout: post
title:  "Rook-Ceph for dynamic Persistent Volume"
date:   2022-11-09 11:15:29 +1100
categories: jekyll Cat2
---

<b>Helm install Rook-Ceph for persistent storage</b>

- Configure local VM block storage to add 50Gb sdb to all k8s master and work nodes

- install rook-ceph cluster

{% highlight shell %}
git clone --single-branch --branch master https://github.com/rook/rook.git
cd rook/deploy/examples
kubectl create -f crds.yaml -f common.yaml -f operator.yaml
kubectl create -f cluster.yaml
{% endhighlight %}

- Ceph toolbox to check cluster status

{% highlight shell %}
kubectl create -f toolbox.yaml
kubectl -n rook-ceph exec -it deploy/rook-ceph-tools -- bash
ceph status
ceph osd status
ceph df
rados df
{% endhighlight %}

- Ceph Dashboard svc for https login

{% highlight shell %}
kubectl create -f dashboard-external-https.yaml
kubectl -n rook-ceph get secret rook-ceph-dashboard-password -o jsonpath="{['data']['password']}" | base64 --decode && echo
{% endhighlight %}

- Create storage pool and storageclass

{% highlight shell %}
kubectl create -f pool.yaml
cd csi/rbd
kubectl create -f storageclass.yaml
{% endhighlight %}

- set "rook-ceph-block" as default sc

{% highlight shell %}
kubectl patch storageclass rook-ceph-block -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'

kubectl get sc
NAME                        PROVISIONER                  RECLAIMPOLICY  VOLUMEBINDINGMODE  ALLOWVOLUMEEXPANSION   AGE
rook-ceph-block (default)   rook-ceph.rbd.csi.ceph.com   Delete          Immediate          true                  8d
{% endhighlight %}

check pool and OSDs in ceph webui

![image tooltip here](/assets/ceph.png)


